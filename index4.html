<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Darts Subtraction Trainer</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111" />
  <meta name="apple-mobile-web-app-capable" content="yes">

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #0b0b0b; color: #f2f2f2; }
    .wrap { max-width: 560px; margin: 0 auto; padding: 18px; }
    .card { background: #151515; border: 1px solid #2a2a2a; border-radius: 18px; padding: 16px; box-shadow: 0 6px 18px rgba(0,0,0,.25); }
    h1 { font-size: 20px; margin: 0 0 10px; letter-spacing: .2px; }
    .row { display: flex; gap: 12px; }
    .row > * { flex: 1; }
    label { display: block; font-size: 12px; opacity: .85; margin-bottom: 6px; }
    input, select, button {
      width: 100%;
      border-radius: 14px;
      border: 1px solid #2a2a2a;
      background: #0f0f0f;
      color: #f2f2f2;
      padding: 12px 12px;
      font-size: 16px;
      outline: none;
    }
    input:focus, select:focus { border-color: #5a5a5a; }
    button { background: #1f1f1f; font-weight: 700; }
    button:active { transform: scale(.99); }
    .big { font-size: 44px; font-weight: 900; line-height: 1; margin: 6px 0 14px; }
    .pill { display: inline-block; padding: 6px 10px; border-radius: 999px; background: #101010; border: 1px solid #2a2a2a; font-size: 12px; opacity: .95; }
    .subpill { margin-top: -8px; font-size: 12px; opacity: .85; }
    .msg { margin-top: 10px; padding: 10px 12px; border-radius: 14px; border: 1px solid #2a2a2a; background: #0f0f0f; }
    .ok { border-color: #1f6d3a; }
    .bad { border-color: #8a2a2a; }
    .muted { opacity: .85; font-size: 12px; }
    .spacer { height: 12px; }
    .btnrow { display: flex; gap: 10px; }
    .btnrow button { flex: 1; }

    .stats {
      margin-top: 12px;
      padding: 12px;
      border-radius: 16px;
      background: #101010;
      border: 1px solid #2a2a2a;
    }
    .stats h2 { font-size: 14px; margin: 0 0 10px; opacity: .9; letter-spacing: .2px; }
    .statgrid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .stat { border-radius: 14px; border: 1px solid #2a2a2a; background: #0f0f0f; padding: 10px; }
    .stat .k { font-size: 11px; opacity: .85; }
    .stat .v { font-size: 18px; font-weight: 800; margin-top: 4px; }
    .hint { margin-top: 10px; font-size: 12px; opacity: .8; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>üéØ Darts Subtraction Trainer (Double Out)</h1>

      <div class="row">
        <div>
          <label>Start</label>
          <select id="startScore">
            <option value="501" selected>501</option>
            <option value="301">301</option>
          </select>
        </div>
        <div>
          <label>Max visit</label>
          <select id="maxThrow">
            <option value="60">60 (Easy)</option>
            <option value="120">120 (Mid)</option>
            <option value="180" selected>180 (Normal)</option>
          </select>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="row">
        <div>
          <div class="pill">Player total</div>
          <div id="remaining" class="big">501</div>
        </div>
        <div style="text-align:right">
          <div class="pill">Visit total</div>
          <div id="throw" class="big">‚Äî</div>
          <div class="subpill">Last dart: <b id="lastDart">‚Äî</b></div>
        </div>
      </div>

      <label>Your answer (new total)</label>
      <input id="answer" inputmode="numeric" pattern="[0-9]*" placeholder="Type the new total‚Ä¶" />

      <div class="spacer"></div>

      <div class="btnrow">
        <button id="checkBtn">Check</button>
        <button id="nextBtn" title="Generate a new visit">Next throw</button>
      </div>

      <div class="spacer"></div>

      <div class="btnrow">
        <button id="resetBtn">Reset</button>
        <button id="revealBtn">Reveal answer</button>
      </div>

      <div id="message" class="msg muted">
        Tap <b>Next throw</b> to begin.
      </div>

      <div class="stats" aria-label="Stats">
        <h2>üìä Stats</h2>
        <div class="statgrid">
          <div class="stat"><div class="k">Turns</div><div class="v" id="stTurns">0</div></div>
          <div class="stat"><div class="k">Correct</div><div class="v" id="stCorrect">0</div></div>
          <div class="stat"><div class="k">Wrong</div><div class="v" id="stWrong">0</div></div>

          <div class="stat"><div class="k">Accuracy</div><div class="v" id="stAcc">0%</div></div>
          <div class="stat"><div class="k">Streak</div><div class="v" id="stStreak">0</div></div>
          <div class="stat"><div class="k">Best streak</div><div class="v" id="stBest">0</div></div>
        </div>
        <div class="hint">
          Rule: You must finish on <b>exactly 0</b>, and the <b>last dart must be a double</b> (bull = D25).
          Wrong answers don‚Äôt reduce the total ‚Äî you retry the same throw.
        </div>
      </div>
    </div>
  </div>

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(() => {});
    });
  }

  // --- State ---
  let start = 501;
  let maxThrow = 180;
  let remaining = 501;

  // current visit
  let currentThrow = null;     // total points
  let currentLast = "‚Äî";       // e.g., D16
  let lastIsDouble = false;    // true if last dart is double (incl D25)

  // Stats
  let turns = 0, correct = 0, wrong = 0, streak = 0, bestStreak = 0;

  // --- Elements ---
  const elStart = document.getElementById("startScore");
  const elMax = document.getElementById("maxThrow");
  const elRemaining = document.getElementById("remaining");
  const elThrow = document.getElementById("throw");
  const elLast = document.getElementById("lastDart");
  const elAnswer = document.getElementById("answer");
  const elMsg = document.getElementById("message");

  const btnCheck = document.getElementById("checkBtn");
  const btnNext = document.getElementById("nextBtn");
  const btnReset = document.getElementById("resetBtn");
  const btnReveal = document.getElementById("revealBtn");

  const stTurns = document.getElementById("stTurns");
  const stCorrect = document.getElementById("stCorrect");
  const stWrong = document.getElementById("stWrong");
  const stAcc = document.getElementById("stAcc");
  const stStreak = document.getElementById("stStreak");
  const stBest = document.getElementById("stBest");

  function setMessage(text, kind = "muted") {
    elMsg.className = "msg " + kind;
    elMsg.innerHTML = text;
  }

  function syncUI() {
    elRemaining.textContent = remaining;
    elThrow.textContent = (currentThrow === null) ? "‚Äî" : currentThrow;
    elLast.textContent = currentLast;
  }

  function syncStats() {
    stTurns.textContent = turns;
    stCorrect.textContent = correct;
    stWrong.textContent = wrong;
    const acc = turns ? Math.round((correct / turns) * 100) : 0;
    stAcc.textContent = acc + "%";
    stStreak.textContent = streak;
    stBest.textContent = bestStreak;
  }

  function resetGame() {
    start = parseInt(elStart.value, 10);
    maxThrow = parseInt(elMax.value, 10);
    remaining = start;

    currentThrow = null;
    currentLast = "‚Äî";
    lastIsDouble = false;

    turns = 0; correct = 0; wrong = 0; streak = 0; bestStreak = 0;

    elAnswer.value = "";
    syncUI();
    syncStats();
    setMessage('Tap <b>Next throw</b> to begin.', "muted");
    elAnswer.focus();
  }

  // ---- Realistic dart generator (3 darts) ----
  // Singles 1-20, Doubles 1-20, Trebles 1-20, plus S25 and D25 (bull)
  function randomDart() {
    const r = Math.random();

    // 0..0.47 singles 1-20
    if (r < 0.48) {
      const n = 1 + Math.floor(Math.random() * 20);
      return { label: "S" + n, score: n, isDouble: false };
    }

    // 0.48..0.73 doubles 1-20
    if (r < 0.74) {
      const n = 1 + Math.floor(Math.random() * 20);
      return { label: "D" + n, score: 2 * n, isDouble: true };
    }

    // 0.74..0.97 trebles 1-20
    if (r < 0.98) {
      const n = 1 + Math.floor(Math.random() * 20);
      return { label: "T" + n, score: 3 * n, isDouble: false };
    }

    // small chance of bull (S25 or D25)
    return Math.random() < 0.5
      ? { label: "S25", score: 25, isDouble: false }
      : { label: "D25", score: 50, isDouble: true };
  }

  function generateVisit(maxTotal) {
    // Keep generating until total <= maxTotal (so your difficulty still works)
    while (true) {
      const d1 = randomDart();
      const d2 = randomDart();
      const d3 = randomDart();
      const total = d1.score + d2.score + d3.score;
      if (total <= maxTotal) {
        return { total, lastLabel: d3.label, lastIsDouble: d3.isDouble };
      }
    }
  }

  function newThrow() {
    const v = generateVisit(maxThrow);
    currentThrow = v.total;
    currentLast = v.lastLabel;
    lastIsDouble = v.lastIsDouble;

    elAnswer.value = "";
    syncUI();
    setMessage("Subtract the visit total. To win, you must hit <b>exactly 0</b> and the <b>last dart must be a double</b>.", "muted");
    elAnswer.focus();
  }

  function checkAnswer() {
    if (currentThrow === null) {
      setMessage('Tap <b>Next throw</b> first.', "muted");
      return;
    }

    const raw = elAnswer.value.trim();
    if (raw === "" || isNaN(raw)) {
      setMessage("Type a number for the new total.", "bad");
      return;
    }

    const ans = parseInt(raw, 10);
    const expected = remaining - currentThrow;

    turns += 1;

    // Must not go negative
    if (expected < 0) {
      wrong += 1;
      streak = 0;
      syncStats();
      setMessage("‚ùå That would go below zero. You must finish on exactly <b>0</b>.", "bad");
      elAnswer.select(); elAnswer.focus();
      return;
    }

    // Must match expected
    if (ans !== expected) {
      wrong += 1;
      streak = 0;
      syncStats();
      setMessage("‚ùå Wrong. Try again (same total, same throw).", "bad");
      elAnswer.select(); elAnswer.focus();
      return;
    }

    // If finishing (expected == 0), last dart must be a double
    if (expected === 0 && !lastIsDouble) {
      wrong += 1;
      streak = 0;
      syncStats();
      setMessage(`‚ùå You hit 0, but you didn‚Äôt finish on a double. Last dart was <b>${currentLast}</b>. Try again.`, "bad");
      elAnswer.select(); elAnswer.focus();
      return;
    }

    // Correct and valid
    correct += 1;
    streak += 1;
    if (streak > bestStreak) bestStreak = streak;

    remaining = expected;
    syncUI();
    syncStats();

    if (remaining === 0) {
      setMessage("üéØ Double out! You reached <b>0</b>. Tap <b>Reset</b> to play again.", "ok");
      currentThrow = null;
      currentLast = "‚Äî";
      lastIsDouble = false;
      syncUI();
      return;
    }

    setMessage(`‚úÖ Correct! New total: <b>${remaining}</b>.`, "ok");
    setTimeout(newThrow, 350);
  }

  function revealAnswer() {
    if (currentThrow === null) {
      setMessage('Tap <b>Next throw</b> first.', "muted");
      return;
    }
    const expected = remaining - currentThrow;
    let extra = "";
    if (expected === 0 && !lastIsDouble) extra = ` (but it‚Äôs NOT a double finish: last dart ${currentLast})`;
    setMessage(`Answer is <b>${expected}</b>${extra}.`, "muted");
    elAnswer.value = expected;
    elAnswer.focus();
    elAnswer.select();
  }

  btnNext.addEventListener("click", newThrow);
  btnCheck.addEventListener("click", checkAnswer);
  btnReset.addEventListener("click", resetGame);
  btnReveal.addEventListener("click", revealAnswer);

  elStart.addEventListener("change", resetGame);
  elMax.addEventListener("change", resetGame);

  elAnswer.addEventListener("keydown", (e) => {
    if (e.key === "Enter") checkAnswer();
  });

  resetGame();
</script>
</body>
</html>
